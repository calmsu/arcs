<!DOCTYPE html>  <html> <head>   <title>search.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="discussion.html">                 discussion.coffee               </a>                                           <a class="source" href="hotspot.html">                 hotspot.coffee               </a>                                           <a class="source" href="resource.html">                 resource.coffee               </a>                                           <a class="source" href="search.html">                 search.coffee               </a>                                           <a class="source" href="tag.html">                 tag.coffee               </a>                                           <a class="source" href="toolbar.html">                 toolbar.coffee               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               search.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>                            </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">arcs</span><span class="p">.</span><span class="nx">views</span><span class="p">.</span><span class="nx">Search</span> <span class="k">extends</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span>

    <span class="nv">initialize: </span><span class="o">-&gt;</span>
        <span class="nv">query = </span><span class="nx">arcs</span><span class="p">.</span><span class="nx">hash</span><span class="p">()</span> <span class="o">or</span> <span class="kc">null</span> 

        <span class="vi">@collection = </span><span class="k">new</span> <span class="nx">arcs</span><span class="p">.</span><span class="nx">collections</span><span class="p">.</span><span class="nx">ResultSet</span>

        <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;.btn[rel=tooltip]&#39;</span><span class="p">).</span><span class="nx">tooltip</span>
            <span class="nv">placement: </span><span class="s1">&#39;bottom&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>Set up drag to select</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#search-results&#39;</span><span class="p">).</span><span class="nx">selectable</span>
            <span class="nv">distance: </span><span class="mi">20</span>
            <span class="nv">filter: </span><span class="s1">&#39;img&#39;</span>
            <span class="nv">selecting: </span><span class="nf">(e, ui) -&gt;</span>
                <span class="nx">$</span><span class="p">(</span><span class="nx">ui</span><span class="p">.</span><span class="nx">selecting</span><span class="p">).</span><span class="nx">parent</span><span class="p">().</span><span class="nx">addClass</span><span class="p">(</span><span class="s1">&#39;selected&#39;</span><span class="p">)</span>
            <span class="nv">selected: </span><span class="nf">(e, ui) -&gt;</span>
                <span class="nx">$</span><span class="p">(</span><span class="nx">ui</span><span class="p">.</span><span class="nx">selected</span><span class="p">).</span><span class="nx">parent</span><span class="p">().</span><span class="nx">addClass</span><span class="p">(</span><span class="s1">&#39;selected&#39;</span><span class="p">)</span>
            <span class="nv">unselecting: </span><span class="nf">(e, ui) -&gt;</span>
                <span class="nx">$</span><span class="p">(</span><span class="nx">ui</span><span class="p">.</span><span class="nx">unselecting</span><span class="p">).</span><span class="nx">parent</span><span class="p">().</span><span class="nx">removeClass</span><span class="p">(</span><span class="s1">&#39;selected&#39;</span><span class="p">)</span>
            <span class="nv">unselected: </span><span class="nf">(e, ui) -&gt;</span>
                <span class="nx">$</span><span class="p">(</span><span class="nx">ui</span><span class="p">.</span><span class="nx">unselected</span><span class="p">).</span><span class="nx">parent</span><span class="p">().</span><span class="nx">removeClass</span><span class="p">(</span><span class="s1">&#39;selected&#39;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>Set up Visual Search</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="vi">@search = </span><span class="nx">VS</span><span class="p">.</span><span class="nx">init</span>
            <span class="nv">container: </span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#search-wrapper&#39;</span><span class="p">)</span>
            <span class="nv">query: </span><span class="nx">query</span> <span class="o">or</span> <span class="s1">&#39;&#39;</span>
            <span class="nv">callbacks:</span>
                <span class="nv">search: </span><span class="p">(</span><span class="nx">query</span><span class="p">,</span> <span class="nx">searchCollection</span><span class="p">)</span> <span class="o">=&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>Hand it off to the doSearch method</p>             </td>             <td class="code">               <div class="highlight"><pre>                    <span class="err">@</span><span class="p">.</span><span class="nx">doSearch</span> <span class="nx">searchCollection</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">()</span>
                    <span class="nx">arcs</span><span class="p">.</span><span class="nx">hash</span> <span class="nx">query</span>
                <span class="nv">facetMatches: </span><span class="nf">(callback) -&gt;</span>
                    <span class="nx">callback</span> <span class="p">[</span>
                        <span class="s1">&#39;id&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;sha&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;user&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;tag&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;collection&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;date&#39;</span>
                    <span class="p">]</span>
                <span class="nv">valueMatches: </span><span class="nf">(facet, searchTerm, callback) -&gt;</span>
                    <span class="nx">callback</span> <span class="p">[</span>
                        <span class="s1">&#39;Jon Frey&#39;</span>
                    <span class="p">]</span>

        <span class="err">@</span><span class="p">.</span><span class="nx">doSearch</span><span class="p">(</span><span class="nx">@search</span><span class="p">.</span><span class="nx">searchQuery</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">())</span>

        <span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">).</span><span class="nx">keydown</span> <span class="err">@</span><span class="p">.</span><span class="nx">keydownDelegate</span>

    <span class="nv">events:</span>
        <span class="s1">&#39;dblclick img&#39;</span><span class="o">:</span> <span class="s1">&#39;openResult&#39;</span>
        <span class="s1">&#39;click img&#39;</span><span class="o">:</span> <span class="s1">&#39;selectResult&#39;</span>
        <span class="s1">&#39;click .result&#39;</span><span class="o">:</span> <span class="s1">&#39;unselectAll&#39;</span>
        <span class="s1">&#39;click #search-results&#39;</span><span class="o">:</span> <span class="s1">&#39;unselectAll&#39;</span>
        <span class="s1">&#39;click #open-btn&#39;</span><span class="o">:</span> <span class="s1">&#39;openSelected&#39;</span>
        <span class="s1">&#39;click #collection-btn&#39;</span><span class="o">:</span> <span class="s1">&#39;makeCollectionFromSelected&#39;</span>
        <span class="s1">&#39;click #bookmark-btn&#39;</span><span class="o">:</span> <span class="s1">&#39;bookmarkSelected&#39;</span>
        <span class="s1">&#39;click #tag-btn&#39;</span><span class="o">:</span> <span class="s1">&#39;tagModal&#39;</span>
        <span class="s1">&#39;click #grid-btn&#39;</span><span class="o">:</span> <span class="s1">&#39;gridView&#39;</span>
        <span class="s1">&#39;click #list-btn&#39;</span><span class="o">:</span> <span class="s1">&#39;listView&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Super hacky query string parser.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">_jsonifyFacets: </span><span class="nf">(queryStr) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>We'll occasionally only have the query stored as the url hash (for 
example when the search url is linked). In this case, we need to parse
the query into an object to send to the server.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nv">keys = </span><span class="p">(</span><span class="nx">k</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">k</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="nx">k</span> <span class="k">in</span> <span class="nx">queryStr</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/(\S+):/g</span><span class="p">))</span>
        <span class="nv">values = </span><span class="p">(</span><span class="nx">v</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">v</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="nx">v</span> <span class="k">in</span> <span class="nx">queryStr</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/&quot;(?:[^\\&quot;]+|\\.)*&quot;/g</span><span class="p">))</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>I need object comprehensions to exist.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nv">objs = </span><span class="p">[]</span>
        <span class="k">for</span> <span class="nx">arr</span> <span class="k">in</span> <span class="nx">_</span><span class="p">.</span><span class="nx">zip</span> <span class="nx">keys</span><span class="p">,</span> <span class="nx">values</span>
            <span class="nv">obj = </span><span class="p">{}</span>
            <span class="nx">obj</span><span class="p">[</span><span class="nx">arr</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="nx">arr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="nx">objs</span><span class="p">.</span><span class="nx">push</span> <span class="nx">obj</span>
        <span class="nx">objs</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>Send the list of facet objects to the server</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">doSearch: </span><span class="nf">(facets=null) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>Get rid of the app key, server doesn't need it.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">_</span><span class="p">.</span><span class="nx">each</span> <span class="nx">facets</span><span class="p">,</span> <span class="nf">(f) -&gt;</span>
            <span class="k">delete</span> <span class="nx">f</span><span class="p">.</span><span class="nx">app</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>Send the search facets as a JSON POST.
Yeah it's not semantic, but I don't want to put the JSON in a url 
param.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">@collection</span><span class="p">.</span><span class="nx">fetch</span>
            <span class="nv">data: </span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">facets</span><span class="p">)</span>
            <span class="nv">type: </span><span class="s1">&#39;POST&#39;</span>
            <span class="nv">contentType: </span><span class="s1">&#39;application/json&#39;</span>
            <span class="nv">success: </span><span class="o">=&gt;</span>
                <span class="err">@</span><span class="p">.</span><span class="nx">render</span><span class="p">()</span>
            <span class="nv">error: </span><span class="o">-&gt;</span>
                <span class="nx">arcs</span><span class="p">.</span><span class="nx">log</span> <span class="s1">&#39;error&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>Delegate search related hotkeys, let the others go.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">keydownDelegate: </span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="o">=&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p><ctrl-a></p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">metaKey</span> <span class="o">or</span> <span class="nx">e</span><span class="p">.</span><span class="nx">ctrlKey</span><span class="p">)</span> <span class="o">and</span> <span class="nx">e</span><span class="p">.</span><span class="nx">keyCode</span> <span class="o">==</span> <span class="mi">65</span>
            <span class="err">@</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">()</span>
            <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">()</span>

    <span class="nv">makeCollectionFromSelected: </span><span class="o">-&gt;</span>
        <span class="nv">ids = </span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="nx">el</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s1">&#39;img&#39;</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;data-id&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="nx">el</span> <span class="k">in</span> <span class="err">@</span><span class="p">.</span><span class="nx">getSelected</span><span class="p">().</span><span class="nx">get</span><span class="p">())</span>

        <span class="nv">collection = </span>
            <span class="nv">Collection:</span>
                <span class="nv">title: </span><span class="s1">&#39;Virtual collection&#39;</span>
                <span class="nv">description: </span><span class="s2">&quot;Results from search, &#39;#{arcs.hash()}&#39;&quot;</span>
                <span class="nv">public: </span><span class="kc">false</span>
            <span class="nv">Members: </span><span class="nx">ids</span>

        <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span>
            <span class="nv">url: </span><span class="nx">arcs</span><span class="p">.</span><span class="nx">baseURL</span> <span class="o">+</span> <span class="s1">&#39;collections/create&#39;</span>
            <span class="nv">data: </span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">collection</span><span class="p">)</span>
            <span class="nv">type: </span><span class="s1">&#39;POST&#39;</span>
            <span class="nv">contentType: </span><span class="s1">&#39;application/json&#39;</span>
            <span class="nv">success: </span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="o">=&gt;</span>
                <span class="nb">window</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="nx">arcs</span><span class="p">.</span><span class="nx">baseURL</span> <span class="o">+</span> <span class="s1">&#39;collection/&#39;</span> <span class="o">+</span> <span class="nx">data</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="s1">&#39;_blank&#39;</span><span class="p">)</span>
            <span class="nv">error: </span><span class="o">-&gt;</span>
                <span class="nx">arcs</span><span class="p">.</span><span class="nx">log</span> <span class="s1">&#39;error&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>Get the selected results.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">getSelected: </span><span class="o">-&gt;</span>
        <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;.result.selected&#39;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>Unselect all.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">unselectAll: </span><span class="nf">(e=null) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>This can run with a jQuery.Event argument.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>If one of the modifier keys is held down, we won't do anything.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="nx">e</span><span class="o">?</span> <span class="o">and</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">metaKey</span> <span class="o">or</span> <span class="nx">e</span><span class="p">.</span><span class="nx">ctrlKey</span> <span class="o">or</span> <span class="nx">e</span><span class="p">.</span><span class="nx">shiftKey</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">false</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>If the target is the image, we won't do anything.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="nx">e</span><span class="o">?</span> <span class="o">and</span> <span class="nx">$</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">).</span><span class="nx">attr</span> <span class="s1">&#39;src&#39;</span>
            <span class="k">return</span> <span class="kc">false</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>Still here? Ok, unselect all results.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="err">@</span><span class="p">.</span><span class="nx">getSelected</span><span class="p">().</span><span class="nx">removeClass</span> <span class="s1">&#39;selected&#39;</span>

    <span class="nv">selectAll: </span><span class="o">-&gt;</span>
        <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;.result&#39;</span><span class="p">).</span><span class="nx">addClass</span> <span class="s1">&#39;selected&#39;</span>

    <span class="nv">toggleAll: </span><span class="o">-&gt;</span>
        <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;.result&#39;</span><span class="p">).</span><span class="nx">toggleClass</span> <span class="s1">&#39;selected&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>Select a result</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">selectResult: </span><span class="nf">(e) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>If <ctrl> <shift> or <meta> is pressed allow multi-select</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="o">not</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">ctrlKey</span> <span class="o">or</span> <span class="nx">e</span><span class="p">.</span><span class="nx">shiftKey</span> <span class="o">or</span> <span class="nx">e</span><span class="p">.</span><span class="nx">metaKey</span><span class="p">)</span>
            <span class="err">@</span><span class="p">.</span><span class="nx">unselectAll</span><span class="p">()</span>
        <span class="nx">$</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">currentTarget</span><span class="p">).</span><span class="nx">parent</span><span class="p">(</span><span class="s1">&#39;.result&#39;</span><span class="p">).</span><span class="nx">toggleClass</span> <span class="s1">&#39;selected&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>Open a result (in a new tab/window)</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">openResult: </span><span class="nf">(e) -&gt;</span>
        <span class="nx">arcs</span><span class="p">.</span><span class="nx">log</span> <span class="s1">&#39;called&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>Allows calling with a jQuery Event (via Backbone)...</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="nx">e</span> <span class="k">instanceof</span> <span class="nx">jQuery</span><span class="p">.</span><span class="nx">Event</span>
            <span class="nv">$el = </span><span class="nx">$</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">currentTarget</span><span class="p">).</span><span class="nx">parent</span><span class="p">()</span>
            <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>..or a DOM Element</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">else</span>
            <span class="nv">$el = </span><span class="nx">$</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span>
        <span class="nv">id = </span><span class="nx">$el</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s1">&#39;img&#39;</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;data-id&#39;</span><span class="p">)</span>
        <span class="nb">window</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="nx">arcs</span><span class="p">.</span><span class="nx">baseURL</span> <span class="o">+</span> <span class="s1">&#39;resource/&#39;</span> <span class="o">+</span> <span class="nx">id</span><span class="p">)</span>

    <span class="nv">tagModal: </span><span class="o">-&gt;</span>
        <span class="nv">n = </span><span class="err">@</span><span class="p">.</span><span class="nx">getSelected</span><span class="p">().</span><span class="nx">length</span>
        <span class="nv">s = </span><span class="k">if</span> <span class="nx">n</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">then</span> <span class="s1">&#39;s&#39;</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>If nothing is selected:</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="nx">n</span> <span class="o">==</span> <span class="mi">0</span>
            <span class="nx">alert</span> <span class="s2">&quot;You must select at least 1 result to tag.&quot;</span>
            <span class="k">return</span>

        <span class="nx">arcs</span><span class="p">.</span><span class="nx">modal</span>
            <span class="nv">template: </span><span class="nx">arcs</span><span class="p">.</span><span class="nx">templates</span><span class="p">.</span><span class="nx">search_modal</span>
            <span class="nv">templateValues:</span>
                <span class="nv">title: </span><span class="s1">&#39;Tag Selected&#39;</span>
                <span class="nv">message: </span><span class="s2">&quot;#{n} resource#{s} will be tagged.&quot;</span>
            <span class="nv">inputs: </span><span class="p">[</span><span class="s1">&#39;search-modal-value&#39;</span><span class="p">]</span>
            <span class="nv">backdrop: </span><span class="kc">true</span>
            <span class="nv">buttons: </span>
                <span class="nv">save:</span>
                    <span class="nv">callback: </span><span class="err">@</span><span class="p">.</span><span class="nx">tagSelected</span>
                    <span class="nv">context: </span><span class="err">@</span>

    <span class="nv">tagResult: </span><span class="nf">(el, tagStr) -&gt;</span> 
        <span class="nv">id = </span><span class="nx">$</span><span class="p">(</span><span class="nx">el</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s1">&#39;img&#39;</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;data-id&#39;</span><span class="p">)</span>
        <span class="nv">tag = </span><span class="k">new</span> <span class="nx">arcs</span><span class="p">.</span><span class="nx">models</span><span class="p">.</span><span class="nx">Tag</span>
            <span class="nv">resource_id: </span><span class="nx">id</span>
            <span class="nv">tag: </span><span class="nx">tagStr</span>
        <span class="nx">tag</span><span class="p">.</span><span class="nx">save</span><span class="p">()</span>

    <span class="nv">tagSelected: </span><span class="nf">(vals) -&gt;</span>
        <span class="nv">tag = </span><span class="nx">vals</span><span class="p">[</span><span class="s1">&#39;search-modal-value&#39;</span><span class="p">]</span>
        <span class="nv">that = </span><span class="err">@</span>
        <span class="err">@</span><span class="p">.</span><span class="nx">getSelected</span><span class="p">().</span><span class="nx">each</span> <span class="o">-&gt;</span>
            <span class="nx">that</span><span class="p">.</span><span class="nx">tagResult</span> <span class="err">@</span><span class="p">,</span> <span class="nx">tag</span>

    <span class="nv">bookmarkResult: </span><span class="nf">(el, noteStr=null) -&gt;</span>
        <span class="nv">id = </span><span class="nx">$</span><span class="p">(</span><span class="nx">el</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s1">&#39;img&#39;</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;data-id&#39;</span><span class="p">)</span>
        <span class="nv">bkmk = </span><span class="k">new</span> <span class="nx">arcs</span><span class="p">.</span><span class="nx">models</span><span class="p">.</span><span class="nx">Bookmark</span>
            <span class="nv">resource_id: </span><span class="nx">id</span>
            <span class="nv">description: </span><span class="nx">noteStr</span> 
        <span class="nx">bkmk</span><span class="p">.</span><span class="nx">save</span><span class="p">()</span>

    <span class="nv">bookmarkSelected: </span><span class="o">-&gt;</span>
        <span class="nv">that = </span><span class="err">@</span>
        <span class="err">@</span><span class="p">.</span><span class="nx">getSelected</span><span class="p">().</span><span class="nx">each</span> <span class="o">-&gt;</span>
            <span class="nx">that</span><span class="p">.</span><span class="nx">bookmarkResult</span> <span class="err">@</span></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>Open all selected results through @.openResult()</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">openSelected: </span><span class="o">-&gt;</span>
        <span class="nv">that = </span><span class="err">@</span>
        <span class="err">@</span><span class="p">.</span><span class="nx">getSelected</span><span class="p">().</span><span class="nx">each</span> <span class="o">-&gt;</span>
            <span class="nx">that</span><span class="p">.</span><span class="nx">openResult</span> <span class="err">@</span> 
    <span class="nv">gridView: </span><span class="o">-&gt;</span>
        <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#list-btn&#39;</span><span class="p">).</span><span class="nx">removeClass</span> <span class="s1">&#39;active&#39;</span>
        <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#grid-btn&#39;</span><span class="p">).</span><span class="nx">addClass</span> <span class="s1">&#39;active&#39;</span>
        <span class="err">@</span><span class="p">.</span><span class="nx">render</span><span class="p">()</span>

    <span class="nv">listView: </span><span class="o">-&gt;</span>
        <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#grid-btn&#39;</span><span class="p">).</span><span class="nx">removeClass</span> <span class="s1">&#39;active&#39;</span>
        <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#list-btn&#39;</span><span class="p">).</span><span class="nx">addClass</span> <span class="s1">&#39;active&#39;</span>
        <span class="err">@</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="nx">list</span><span class="o">=</span><span class="kc">true</span><span class="p">)</span>

    <span class="nv">render: </span><span class="nf">(list=false) -&gt;</span>
        <span class="k">if</span> <span class="nx">list</span>
            <span class="nv">template = </span><span class="nx">arcs</span><span class="p">.</span><span class="nx">templates</span><span class="p">.</span><span class="nx">results_list</span>
        <span class="k">else</span>
            <span class="nv">template = </span><span class="nx">arcs</span><span class="p">.</span><span class="nx">templates</span><span class="p">.</span><span class="nx">results_grid</span>
        <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#search-results&#39;</span><span class="p">).</span><span class="nx">html</span> <span class="nx">Mustache</span><span class="p">.</span><span class="nx">render</span> <span class="nx">template</span><span class="p">,</span> 
            <span class="nv">results: </span><span class="nx">@collection</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">()</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 